"use client";import{useFocusRing as he}from"@react-aria/focus";import{useHover as De}from"@react-aria/interactions";import h,{Fragment as Oe,createContext as se,createRef as _e,useCallback as pe,useContext as ue,useEffect as Ie,useMemo as B,useReducer as Ce,useRef as de,useState as Fe}from"react";import{flushSync as N}from"react-dom";import{useActivePress as Me}from'../../hooks/use-active-press.js';import{useByComparator as Be}from'../../hooks/use-by-comparator.js';import{useControllable as we}from'../../hooks/use-controllable.js';import{useDefaultValue as ke}from'../../hooks/use-default-value.js';import{useDidElementMove as Ue}from'../../hooks/use-did-element-move.js';import{useDisposables as ye}from'../../hooks/use-disposables.js';import{useElementSize as Ne}from'../../hooks/use-element-size.js';import{useEvent as b}from'../../hooks/use-event.js';import{useId as ce}from'../../hooks/use-id.js';import{useInertOthers as He}from'../../hooks/use-inert-others.js';import{useIsoMorphicEffect as fe}from'../../hooks/use-iso-morphic-effect.js';import{useLatestValue as Ge}from'../../hooks/use-latest-value.js';import{useOnDisappear as Ve}from'../../hooks/use-on-disappear.js';import{useOutsideClick as Ke}from'../../hooks/use-outside-click.js';import{useOwnerDocument as ve}from'../../hooks/use-owner.js';import{useResolveButtonType as je}from'../../hooks/use-resolve-button-type.js';import{useScrollLock as ze}from'../../hooks/use-scroll-lock.js';import{useSyncRefs as z}from'../../hooks/use-sync-refs.js';import{useTextValue as We}from'../../hooks/use-text-value.js';import{useTrackedPointer as Qe}from'../../hooks/use-tracked-pointer.js';import{transitionDataAttributes as Xe,useTransition as Je}from'../../hooks/use-transition.js';import{useDisabled as $e}from'../../internal/disabled.js';import{FloatingProvider as qe,useFloatingPanel as Ye,useFloatingPanelProps as Ze,useFloatingReference as et,useFloatingReferenceProps as tt,useResolvedAnchor as ot}from'../../internal/floating.js';import{FormFields as nt}from'../../internal/form-fields.js';import{useFrozenData as it}from'../../internal/frozen.js';import{useProvidedId as rt}from'../../internal/id.js';import{OpenClosedProvider as lt,State as q,useOpenClosed as at}from'../../internal/open-closed.js';import{isDisabledReactIssue7711 as st}from'../../utils/bugs.js';import{Focus as v,calculateActiveIndex as be}from'../../utils/calculate-active-index.js';import{disposables as pt}from'../../utils/disposables.js';import{Focus as ge,FocusableMode as ut,focusFrom as dt,isFocusableElement as ct,sortByDomNode as ft}from'../../utils/focus-management.js';import{attemptSubmit as bt}from'../../utils/form.js';import{match as V}from'../../utils/match.js';import{getOwnerDocument as Tt}from'../../utils/owner.js';import{RenderFeatures as Le,forwardRefWithAs as W,mergeProps as Se,useRender as Q}from'../../utils/render.js';import{useDescribedBy as mt}from'../description/description.js';import{Keys as E}from'../keyboard.js';import{Label as xt,useLabelledBy as Ot,useLabels as yt}from'../label/label.js';import{Portal as vt}from'../portal/portal.js';var gt=(o=>(o[o.Open=0]="Open",o[o.Closed=1]="Closed",o))(gt||{}),Lt=(o=>(o[o.Single=0]="Single",o[o.Multi=1]="Multi",o))(Lt||{}),St=(o=>(o[o.Pointer=0]="Pointer",o[o.Other=1]="Other",o))(St||{}),Et=(n=>(n[n.OpenListbox=0]="OpenListbox",n[n.CloseListbox=1]="CloseListbox",n[n.GoToOption=2]="GoToOption",n[n.Search=3]="Search",n[n.ClearSearch=4]="ClearSearch",n[n.RegisterOption=5]="RegisterOption",n[n.UnregisterOption=6]="UnregisterOption",n[n.SetButtonElement=7]="SetButtonElement",n[n.SetOptionsElement=8]="SetOptionsElement",n))(Et||{});function Te(e,i=o=>o){let o=e.activeOptionIndex!==null?e.options[e.activeOptionIndex]:null,r=ft(i(e.options.slice()),m=>m.dataRef.current.domRef.current),a=o?r.indexOf(o):null;return a===-1&&(a=null),{options:r,activeOptionIndex:a}}let Pt={[1](e){return e.dataRef.current.disabled||e.listboxState===1?e:{...e,activeOptionIndex:null,listboxState:1,__demoMode:!1}},[0](e){if(e.dataRef.current.disabled||e.listboxState===0)return e;let i=e.activeOptionIndex,{isSelected:o}=e.dataRef.current,r=e.options.findIndex(a=>o(a.dataRef.current.value));return r!==-1&&(i=r),{...e,listboxState:0,activeOptionIndex:i,__demoMode:!1}},[2](e,i){var m,O,d,p,n;if(e.dataRef.current.disabled||e.listboxState===1)return e;let o={...e,searchQuery:"",activationTrigger:(m=i.trigger)!=null?m:1,__demoMode:!1};if(i.focus===v.Nothing)return{...o,activeOptionIndex:null};if(i.focus===v.Specific)return{...o,activeOptionIndex:e.options.findIndex(u=>u.id===i.id)};if(i.focus===v.Previous){let u=e.activeOptionIndex;if(u!==null){let P=e.options[u].dataRef.current.domRef,t=be(i,{resolveItems:()=>e.options,resolveActiveIndex:()=>e.activeOptionIndex,resolveId:s=>s.id,resolveDisabled:s=>s.dataRef.current.disabled});if(t!==null){let s=e.options[t].dataRef.current.domRef;if(((O=P.current)==null?void 0:O.previousElementSibling)===s.current||((d=s.current)==null?void 0:d.previousElementSibling)===null)return{...o,activeOptionIndex:t}}}}else if(i.focus===v.Next){let u=e.activeOptionIndex;if(u!==null){let P=e.options[u].dataRef.current.domRef,t=be(i,{resolveItems:()=>e.options,resolveActiveIndex:()=>e.activeOptionIndex,resolveId:s=>s.id,resolveDisabled:s=>s.dataRef.current.disabled});if(t!==null){let s=e.options[t].dataRef.current.domRef;if(((p=P.current)==null?void 0:p.nextElementSibling)===s.current||((n=s.current)==null?void 0:n.nextElementSibling)===null)return{...o,activeOptionIndex:t}}}}let r=Te(e),a=be(i,{resolveItems:()=>r.options,resolveActiveIndex:()=>r.activeOptionIndex,resolveId:u=>u.id,resolveDisabled:u=>u.dataRef.current.disabled});return{...o,...r,activeOptionIndex:a}},[3]:(e,i)=>{if(e.dataRef.current.disabled||e.listboxState===1)return e;let r=e.searchQuery!==""?0:1,a=e.searchQuery+i.value.toLowerCase(),O=(e.activeOptionIndex!==null?e.options.slice(e.activeOptionIndex+r).concat(e.options.slice(0,e.activeOptionIndex+r)):e.options).find(p=>{var n;return!p.dataRef.current.disabled&&((n=p.dataRef.current.textValue)==null?void 0:n.startsWith(a))}),d=O?e.options.indexOf(O):-1;return d===-1||d===e.activeOptionIndex?{...e,searchQuery:a}:{...e,searchQuery:a,activeOptionIndex:d,activationTrigger:1}},[4](e){return e.dataRef.current.disabled||e.listboxState===1||e.searchQuery===""?e:{...e,searchQuery:""}},[5]:(e,i)=>{let o={id:i.id,dataRef:i.dataRef},r=Te(e,a=>[...a,o]);return e.activeOptionIndex===null&&e.dataRef.current.isSelected(i.dataRef.current.value)&&(r.activeOptionIndex=r.options.indexOf(o)),{...e,...r}},[6]:(e,i)=>{let o=Te(e,r=>{let a=r.findIndex(m=>m.id===i.id);return a!==-1&&r.splice(a,1),r});return{...e,...o,activationTrigger:1}},[7]:(e,i)=>e.buttonElement===i.element?e:{...e,buttonElement:i.element},[8]:(e,i)=>e.optionsElement===i.element?e:{...e,optionsElement:i.element}},me=se(null);me.displayName="ListboxActionsContext";function Y(e){let i=ue(me);if(i===null){let o=new Error(`<${e} /> is missing a parent <Listbox /> component.`);throw Error.captureStackTrace&&Error.captureStackTrace(o,Y),o}return i}let Z=se(null);Z.displayName="ListboxDataContext";function X(e){let i=ue(Z);if(i===null){let o=new Error(`<${e} /> is missing a parent <Listbox /> component.`);throw Error.captureStackTrace&&Error.captureStackTrace(o,X),o}return i}function Rt(e,i){return V(i.type,Pt,e,i)}let At=Oe;function ht(e,i){var xe;let o=$e(),{value:r,defaultValue:a,form:m,name:O,onChange:d,by:p,invalid:n=!1,disabled:u=o||!1,horizontal:P=!1,multiple:t=!1,__demoMode:s=!1,...C}=e;const w=P?"horizontal":"vertical";let F=z(i),R=ke(a),[y=t?[]:void 0,g]=we(r,d,R),[A,x]=Ce(Rt,{dataRef:_e(),listboxState:s?0:1,options:[],searchQuery:"",activeOptionIndex:null,activationTrigger:1,optionsVisible:!1,buttonElement:null,optionsElement:null,__demoMode:s}),k=de({static:!1,hold:!1}),M=de(new Map),D=Be(p),T=pe(f=>V(c.mode,{[1]:()=>y.some(S=>D(S,f)),[0]:()=>D(y,f)}),[y]),c=B(()=>({...A,value:y,disabled:u,invalid:n,mode:t?1:0,orientation:w,compare:D,isSelected:T,optionsPropsRef:k,listRef:M}),[y,u,n,t,A,M]);fe(()=>{A.dataRef.current=c},[c]);let U=c.listboxState===0;Ke(U,[c.buttonElement,c.optionsElement],(f,S)=>{var I;x({type:1}),ct(S,ut.Loose)||(f.preventDefault(),(I=c.buttonElement)==null||I.focus())});let L=B(()=>({open:c.listboxState===0,disabled:u,invalid:n,value:y}),[c,u,y,n]),H=b(f=>{let S=c.options.find(I=>I.id===f);S&&j(S.dataRef.current.value)}),ee=b(()=>{if(c.activeOptionIndex!==null){let{dataRef:f,id:S}=c.options[c.activeOptionIndex];j(f.current.value),x({type:2,focus:v.Specific,id:S})}}),te=b(()=>x({type:0})),oe=b(()=>x({type:1})),K=ye(),ne=b((f,S,I)=>{K.dispose(),K.microTask(()=>f===v.Specific?x({type:2,focus:v.Specific,id:S,trigger:I}):x({type:2,focus:f,trigger:I}))}),ie=b((f,S)=>(x({type:5,id:f,dataRef:S}),()=>x({type:6,id:f}))),j=b(f=>V(c.mode,{[0](){return g==null?void 0:g(f)},[1](){let S=c.value.slice(),I=S.findIndex(Ae=>D(Ae,f));return I===-1?S.push(f):S.splice(I,1),g==null?void 0:g(S)}})),re=b(f=>x({type:3,value:f})),le=b(()=>x({type:4})),J=b(f=>{x({type:7,element:f})}),$=b(f=>{x({type:8,element:f})}),l=B(()=>({onChange:j,registerOption:ie,goToOption:ne,closeListbox:oe,openListbox:te,selectActiveOption:ee,selectOption:H,search:re,clearSearch:le,setButtonElement:J,setOptionsElement:$}),[]),[_,G]=yt({inherit:!0}),ae={ref:F},Pe=pe(()=>{if(R!==void 0)return g==null?void 0:g(R)},[g,R]),Re=Q();return h.createElement(G,{value:_,props:{htmlFor:(xe=c.buttonElement)==null?void 0:xe.id},slot:{open:c.listboxState===0,disabled:u}},h.createElement(qe,null,h.createElement(me.Provider,{value:l},h.createElement(Z.Provider,{value:c},h.createElement(lt,{value:V(c.listboxState,{[0]:q.Open,[1]:q.Closed})},O!=null&&y!=null&&h.createElement(nt,{disabled:u,data:{[O]:y},form:m,onReset:Pe}),Re({ourProps:ae,theirProps:C,slot:L,defaultTag:At,name:"Listbox"}))))))}let Dt="button";function _t(e,i){var U;let o=X("Listbox.Button"),r=Y("Listbox.Button"),a=ce(),m=rt(),{id:O=m||`headlessui-listbox-button-${a}`,disabled:d=o.disabled||!1,autoFocus:p=!1,...n}=e,u=z(i,et(),r.setButtonElement),P=tt(),t=b(L=>{switch(L.key){case E.Enter:bt(L.currentTarget);break;case E.Space:case E.ArrowDown:L.preventDefault(),N(()=>r.openListbox()),o.value||r.goToOption(v.First);break;case E.ArrowUp:L.preventDefault(),N(()=>r.openListbox()),o.value||r.goToOption(v.Last);break}}),s=b(L=>{switch(L.key){case E.Space:L.preventDefault();break}}),C=b(L=>{var H;if(st(L.currentTarget))return L.preventDefault();o.listboxState===0?(N(()=>r.closeListbox()),(H=o.buttonElement)==null||H.focus({preventScroll:!0})):(L.preventDefault(),r.openListbox())}),w=b(L=>L.preventDefault()),F=Ot([O]),R=mt(),{isFocusVisible:y,focusProps:g}=he({autoFocus:p}),{isHovered:A,hoverProps:x}=De({isDisabled:d}),{pressed:k,pressProps:M}=Me({disabled:d}),D=B(()=>({open:o.listboxState===0,active:k||o.listboxState===0,disabled:d,invalid:o.invalid,value:o.value,hover:A,focus:y,autofocus:p}),[o.listboxState,o.value,d,A,y,k,o.invalid,p]),T=Se(P(),{ref:u,id:O,type:je(e,o.buttonElement),"aria-haspopup":"listbox","aria-controls":(U=o.optionsElement)==null?void 0:U.id,"aria-expanded":o.listboxState===0,"aria-labelledby":F,"aria-describedby":R,disabled:d||void 0,autoFocus:p,onKeyDown:t,onKeyUp:s,onKeyPress:w,onClick:C},g,x,M);return Q()({ourProps:T,theirProps:n,slot:D,defaultTag:Dt,name:"Listbox.Button"})}let Ee=se(!1),It="div",Ct=Le.RenderStrategy|Le.Static;function Ft(e,i){var J,$;let o=ce(),{id:r=`headlessui-listbox-options-${o}`,anchor:a,portal:m=!1,modal:O=!0,transition:d=!1,...p}=e,n=ot(a),[u,P]=Fe(null);n&&(m=!0);let t=X("Listbox.Options"),s=Y("Listbox.Options"),C=ve(t.buttonElement),w=ve(t.optionsElement),F=at(),[R,y]=Je(d,u,F!==null?(F&q.Open)===q.Open:t.listboxState===0);Ve(R,t.buttonElement,s.closeListbox);let g=t.__demoMode?!1:O&&t.listboxState===0;ze(g,w);let A=t.__demoMode?!1:O&&t.listboxState===0;He(A,{allowed:pe(()=>[t.buttonElement,t.optionsElement],[t.buttonElement,t.optionsElement])});let x=t.listboxState!==0,M=Ue(x,t.buttonElement)?!1:R,D=R&&t.listboxState===1,T=it(D,t.value),c=b(l=>t.compare(T,l)),U=B(()=>{var _;if(n==null||!((_=n==null?void 0:n.to)!=null&&_.includes("selection")))return null;let l=t.options.findIndex(G=>c(G.dataRef.current.value));return l===-1&&(l=0),l},[n,t.options]),L=(()=>{if(n==null)return;if(U===null)return{...n,inner:void 0};let l=Array.from(t.listRef.current.values());return{...n,inner:{listRef:{current:l},index:U}}})(),[H,ee]=Ye(L),te=Ze(),oe=z(i,n?H:null,s.setOptionsElement,P),K=ye();Ie(()=>{var _;let l=t.optionsElement;l&&t.listboxState===0&&l!==((_=Tt(l))==null?void 0:_.activeElement)&&(l==null||l.focus({preventScroll:!0}))},[t.listboxState,t.optionsElement]);let ne=b(l=>{var _,G;switch(K.dispose(),l.key){case E.Space:if(t.searchQuery!=="")return l.preventDefault(),l.stopPropagation(),s.search(l.key);case E.Enter:if(l.preventDefault(),l.stopPropagation(),t.activeOptionIndex!==null){let{dataRef:ae}=t.options[t.activeOptionIndex];s.onChange(ae.current.value)}t.mode===0&&(N(()=>s.closeListbox()),(_=t.buttonElement)==null||_.focus({preventScroll:!0}));break;case V(t.orientation,{vertical:E.ArrowDown,horizontal:E.ArrowRight}):return l.preventDefault(),l.stopPropagation(),s.goToOption(v.Next);case V(t.orientation,{vertical:E.ArrowUp,horizontal:E.ArrowLeft}):return l.preventDefault(),l.stopPropagation(),s.goToOption(v.Previous);case E.Home:case E.PageUp:return l.preventDefault(),l.stopPropagation(),s.goToOption(v.First);case E.End:case E.PageDown:return l.preventDefault(),l.stopPropagation(),s.goToOption(v.Last);case E.Escape:l.preventDefault(),l.stopPropagation(),N(()=>s.closeListbox()),(G=t.buttonElement)==null||G.focus({preventScroll:!0});return;case E.Tab:l.preventDefault(),l.stopPropagation(),N(()=>s.closeListbox()),dt(t.buttonElement,l.shiftKey?ge.Previous:ge.Next);break;default:l.key.length===1&&(s.search(l.key),K.setTimeout(()=>s.clearSearch(),350));break}}),ie=(J=t.buttonElement)==null?void 0:J.id,j=B(()=>({open:t.listboxState===0}),[t.listboxState]),re=Se(n?te():{},{id:r,ref:oe,"aria-activedescendant":t.activeOptionIndex===null||($=t.options[t.activeOptionIndex])==null?void 0:$.id,"aria-multiselectable":t.mode===1?!0:void 0,"aria-labelledby":ie,"aria-orientation":t.orientation,onKeyDown:ne,role:"listbox",tabIndex:t.listboxState===0?0:void 0,style:{...p.style,...ee,"--button-width":Ne(t.buttonElement,!0).width},...Xe(y)}),le=Q();return h.createElement(vt,{enabled:m?e.static||R:!1,ownerDocument:C},h.createElement(Z.Provider,{value:t.mode===1?t:{...t,isSelected:c}},le({ourProps:re,theirProps:p,slot:j,defaultTag:It,features:Ct,visible:M,name:"Listbox.Options"})))}let Mt="div";function Bt(e,i){let o=ce(),{id:r=`headlessui-listbox-option-${o}`,disabled:a=!1,value:m,...O}=e,d=ue(Ee)===!0,p=X("Listbox.Option"),n=Y("Listbox.Option"),u=p.activeOptionIndex!==null?p.options[p.activeOptionIndex].id===r:!1,P=p.isSelected(m),t=de(null),s=We(t),C=Ge({disabled:a,value:m,domRef:t,get textValue(){return s()}}),w=z(i,t,T=>{T?p.listRef.current.set(r,T):p.listRef.current.delete(r)});fe(()=>{if(!p.__demoMode&&p.listboxState===0&&u&&p.activationTrigger!==0)return pt().requestAnimationFrame(()=>{var T,c;(c=(T=t.current)==null?void 0:T.scrollIntoView)==null||c.call(T,{block:"nearest"})})},[t,u,p.__demoMode,p.listboxState,p.activationTrigger,p.activeOptionIndex]),fe(()=>{if(!d)return n.registerOption(r,C)},[C,r,d]);let F=b(T=>{var c;if(a)return T.preventDefault();n.onChange(m),p.mode===0&&(N(()=>n.closeListbox()),(c=p.buttonElement)==null||c.focus({preventScroll:!0}))}),R=b(()=>{if(a)return n.goToOption(v.Nothing);n.goToOption(v.Specific,r)}),y=Qe(),g=b(T=>{y.update(T),!a&&(u||n.goToOption(v.Specific,r,0))}),A=b(T=>{y.wasMoved(T)&&(a||u||n.goToOption(v.Specific,r,0))}),x=b(T=>{y.wasMoved(T)&&(a||u&&n.goToOption(v.Nothing))}),k=B(()=>({active:u,focus:u,selected:P,disabled:a,selectedOption:P&&d}),[u,P,a,d]),M=d?{}:{id:r,ref:w,role:"option",tabIndex:a===!0?void 0:-1,"aria-disabled":a===!0?!0:void 0,"aria-selected":P,disabled:void 0,onClick:F,onFocus:R,onPointerEnter:g,onMouseEnter:g,onPointerMove:A,onMouseMove:A,onPointerLeave:x,onMouseLeave:x},D=Q();return!P&&d?null:D({ourProps:M,theirProps:O,slot:k,defaultTag:Mt,name:"Listbox.Option"})}let wt=Oe;function kt(e,i){let{options:o,placeholder:r,...a}=e,O={ref:z(i)},d=X("ListboxSelectedOption"),p=B(()=>({}),[]),n=d.value===void 0||d.value===null||d.mode===1&&Array.isArray(d.value)&&d.value.length===0,u=Q();return h.createElement(Ee.Provider,{value:!0},u({ourProps:O,theirProps:{...a,children:h.createElement(h.Fragment,null,r&&n?r:o)},slot:p,defaultTag:wt,name:"ListboxSelectedOption"}))}let Ut=W(ht),Nt=W(_t),Ht=xt,Gt=W(Ft),Vt=W(Bt),Kt=W(kt),Mo=Object.assign(Ut,{Button:Nt,Label:Ht,Options:Gt,Option:Vt,SelectedOption:Kt});export{Mo as Listbox,Nt as ListboxButton,Ht as ListboxLabel,Vt as ListboxOption,Gt as ListboxOptions,Kt as ListboxSelectedOption};
